name: Dependabot Security Updates

on:
  pull_request:
    branches: [master, main]
  schedule:
    # Executa diariamente às 2h da manhã UTC
    - cron: '0 2 * * *'

jobs:
  security-updates:
    name: Security Updates Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          pnpm install
          cd server && pnpm install
          cd ../web && pnpm install

      - name: Run security audit
        run: |
          echo "Running security audit..."
          pnpm audit --audit-level moderate || true
          cd server && pnpm audit --audit-level moderate || true
          cd ../web && pnpm audit --audit-level moderate || true

      - name: Check for outdated dependencies
        run: |
          echo "Checking for outdated dependencies..."
          pnpm outdated || true
          cd server && pnpm outdated || true
          cd ../web && pnpm outdated || true

      - name: Create security report
        run: |
          echo "## Security Report" > security-report.md
          echo "Generated on: $(date)" >> security-report.md
          echo "" >> security-report.md
          echo "### Audit Results" >> security-report.md
          pnpm audit --audit-level moderate --json >> security-report.md || true
          echo "" >> security-report.md
          echo "### Outdated Dependencies" >> security-report.md
          pnpm outdated >> security-report.md || true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
          retention-days: 7

  auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: Enable auto-merge for Dependabot PRs
        run: |
          gh pr merge --auto --merge "$PR_URL"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }} 